dXNpbmcgU3lzdGVtOw0KdXNpbmcgU3lzdGVtLldpbmRvd3MuRm9ybXM7DQp1c2luZyBTeXN0ZW0uTWFuYWdlbWVudDsNCnVzaW5nIFN5c3RlbS5OZXQ7DQp1c2luZyBTeXN0ZW0uRGlhZ25vc3RpY3M7DQp1c2luZyBTeXN0ZW0uSU87DQp1c2luZyBTeXN0ZW0uVGV4dDsNCnVzaW5nIFN5c3RlbS5Db2xsZWN0aW9ucy5TcGVjaWFsaXplZDsNCnVzaW5nIFN5c3RlbS5EcmF3aW5nLkltYWdpbmc7DQp1c2luZyBTeXN0ZW0uRHJhd2luZzsNCnVzaW5nIFN5c3RlbS5UaHJlYWRpbmc7DQoNCnVzaW5nIFN5c3RlbS5Db2xsZWN0aW9ucy5HZW5lcmljOw0KdXNpbmcgU3lzdGVtLkdsb2JhbGl6YXRpb247DQp1c2luZyBTeXN0ZW0uUnVudGltZS5JbnRlcm9wU2VydmljZXM7DQp1c2luZyBNaWNyb3NvZnQuV2luMzIuU2FmZUhhbmRsZXM7DQp1c2luZyBNaWNyb3NvZnQuV2luMzI7DQoNCm5hbWVzcGFjZSBtYW5zX25vdF9ob3QNCnsNCiAgICBjbGFzcyBQcm9ncmFtDQogICAgew0KCQkNCglzdGF0aWMgdm9pZCBFeGVjdXRlQ29tbWFuZChzdHJpbmcgY29tbWFuZCkNCnsNCn0NCnB1YmxpYyBzdGF0aWMgc3RyaW5nIGRpc2NvcmQgPSAiaHR0cHM6Ly9kaXNjb3JkYXBwLmNvbS9hcGkvd2ViaG9va3MvNDE0NTI2OTg3ODQ0MTkwMjE4LzJ2b0NDSjNTRG5remIwRnVfNWdXSDd6dUhpTTlnZHZVcHY2TjQtOUxiS1JwN3luTkJfeEhndU9vUTJRR3NSeGtrNjJIIjsNCnB1YmxpYyBzdGF0aWMgc3RyaW5nIHNjaWYgPSAiIjsNCnB1YmxpYyBzdGF0aWMgYm9vbCBsb2dnaW5nID0gZmFsc2U7DQpwdWJsaWMgc3RyaW5nIGxhc3RSZXEgPSAiIjsNCg0KDQogICAgICAgIHByaXZhdGUgY29uc3QgaW50IE1PVVNFRVZFTlRGX0xFRlRET1dOID0gMHgwMjsNCiAgICAgICAgcHJpdmF0ZSBjb25zdCBpbnQgTU9VU0VFVkVOVEZfTEVGVFVQID0gMHgwNDsNCiAgICAgICAgcHJpdmF0ZSBjb25zdCBpbnQgTU9VU0VFVkVOVEZfUklHSFRET1dOID0gMHgwODsNCiAgICAgICAgcHJpdmF0ZSBjb25zdCBpbnQgTU9VU0VFVkVOVEZfUklHSFRVUCA9IDB4MTA7DQoJCXByaXZhdGUgY29uc3QgaW50IFNXX0hJREUgPSAwOw0KICAgICAgICBwcml2YXRlIGNvbnN0IGludCBTV19TSE9XID0gMTsNCgkJDQoJCVtEbGxJbXBvcnQoInVzZXIzMi5kbGwiKV0NCiAgICAgICAgcHJpdmF0ZSBzdGF0aWMgZXh0ZXJuIGludCBGaW5kV2luZG93KHN0cmluZyBjbGFzc05hbWUsIHN0cmluZyB3aW5kb3dUZXh0KTsNCg0KICAgICAgICBbRGxsSW1wb3J0KCJ1c2VyMzIuZGxsIildDQogICAgICAgIHByaXZhdGUgc3RhdGljIGV4dGVybiBpbnQgU2hvd1dpbmRvdyhpbnQgaHduZCwgaW50IGNvbW1hbmQpOw0KDQogICAgICAgIFtEbGxJbXBvcnQoInVzZXIzMi5kbGwiKV0NCiAgICAgICAgcHVibGljIHN0YXRpYyBleHRlcm4gaW50IEZpbmRXaW5kb3dFeChpbnQgcGFyZW50SGFuZGxlLCBpbnQgY2hpbGRBZnRlciwgc3RyaW5nIGNsYXNzTmFtZSwgaW50IHdpbmRvd1RpdGxlKTsNCg0KICAgICAgICBbRGxsSW1wb3J0KCJ1c2VyMzIuZGxsIildDQogICAgICAgIHByaXZhdGUgc3RhdGljIGV4dGVybiBpbnQgR2V0RGVza3RvcFdpbmRvdygpOw0KCQkNCltEbGxJbXBvcnQoInVzZXIzMi5kbGwiKV0NCnB1YmxpYyBzdGF0aWMgZXh0ZXJuIGludCBHZXRBc3luY0tleVN0YXRlKEludDMyIGkpOw0KDQpbRGxsSW1wb3J0KCJ1c2VyMzIuZGxsIildDQogICAgICAgIHB1YmxpYyBzdGF0aWMgZXh0ZXJuIEludDMyIFN3YXBNb3VzZUJ1dHRvbihJbnQzMiBiU3dhcCk7DQoJCQ0KCQlbRGxsSW1wb3J0KCJ1c2VyMzIuZGxsIiwgQ2hhclNldCA9IENoYXJTZXQuQXV0bywgQ2FsbGluZ0NvbnZlbnRpb24gPSBDYWxsaW5nQ29udmVudGlvbi5TdGRDYWxsKV0NCiAgICAgICAgcHVibGljIHN0YXRpYyBleHRlcm4gdm9pZCBtb3VzZV9ldmVudCh1aW50IGR3RmxhZ3MsIHVpbnQgZHgsIHVpbnQgZHksIHVpbnQgY0J1dHRvbnMsIHVpbnQgZHdFeHRyYUluZm8pOw0KCQkNCgkJIFtEbGxJbXBvcnQoInVzZXIzMi5kbGwiLCBFbnRyeVBvaW50ID0gIlNldFdpbmRvd1RleHQiKV0NCiAgICAgICAgcHJpdmF0ZSBzdGF0aWMgZXh0ZXJuIGludCBTZXRXaW5kb3dUZXh0KEludFB0ciBoV25kLCBzdHJpbmcgdGV4dCk7DQoNCiAgICAgICAgW0RsbEltcG9ydCgidXNlcjMyLmRsbCIsIEVudHJ5UG9pbnQgPSAiRmluZFdpbmRvd0V4IildDQogICAgICAgIHByaXZhdGUgc3RhdGljIGV4dGVybiBJbnRQdHIgRmluZFdpbmRvd0V4KEludFB0ciBod25kUGFyZW50LCBJbnRQdHIgaHduZENoaWxkQWZ0ZXIsIHN0cmluZyBscHN6Q2xhc3MsIHN0cmluZyBscHN6V2luZG93KTsNCg0KICAgICAgICBbRGxsSW1wb3J0KCJVc2VyMzIuZGxsIiwgRW50cnlQb2ludCA9ICJTZW5kTWVzc2FnZSIpXQ0KICAgICAgICBwcml2YXRlIHN0YXRpYyBleHRlcm4gaW50IFNlbmRNZXNzYWdlKEludFB0ciBoV25kLCBpbnQgdU1zZywgaW50IHdQYXJhbSwgc3RyaW5nIGxQYXJhbSk7DQoNCgkJc3RhdGljIHN0cmluZyBHZXRNYWNoaW5lR3VpZCgpDQp7DQogICBzdHJpbmcgbG9jYXRpb24gPSBAIlNPRlRXQVJFXE1pY3Jvc29mdFxDcnlwdG9ncmFwaHkiOw0KICAgc3RyaW5nIG5hbWUgPSAiTWFjaGluZUd1aWQiOw0KDQogICB1c2luZyAoUmVnaXN0cnlLZXkgbG9jYWxNYWNoaW5lWDY0VmlldyA9IA0KICAgICAgIFJlZ2lzdHJ5S2V5Lk9wZW5CYXNlS2V5KFJlZ2lzdHJ5SGl2ZS5Mb2NhbE1hY2hpbmUsIFJlZ2lzdHJ5Vmlldy5SZWdpc3RyeTY0KSkNCiAgIHsNCiAgICAgICB1c2luZyAoUmVnaXN0cnlLZXkgcmsgPSBsb2NhbE1hY2hpbmVYNjRWaWV3Lk9wZW5TdWJLZXkobG9jYXRpb24pKQ0KICAgICAgIHsNCiAgICAgICAgICAgaWYgKHJrID09IG51bGwpDQogICAgICAgICAgICAgICB0aHJvdyBuZXcgS2V5Tm90Rm91bmRFeGNlcHRpb24oDQogICAgICAgICAgICAgICAgICAgc3RyaW5nLkZvcm1hdCgiS2V5IE5vdCBGb3VuZDogezB9IiwgbG9jYXRpb24pKTsNCg0KICAgICAgICAgICBvYmplY3QgbWFjaGluZUd1aWQgPSByay5HZXRWYWx1ZShuYW1lKTsNCiAgICAgICAgICAgaWYgKG1hY2hpbmVHdWlkID09IG51bGwpDQogICAgICAgICAgICAgICB0aHJvdyBuZXcgSW5kZXhPdXRPZlJhbmdlRXhjZXB0aW9uKA0KICAgICAgICAgICAgICAgICAgIHN0cmluZy5Gb3JtYXQoIkluZGV4IE5vdCBGb3VuZDogezB9IiwgbmFtZSkpOw0KDQogICAgICAgICAgIHJldHVybiBtYWNoaW5lR3VpZC5Ub1N0cmluZygpOw0KICAgICAgIH0NCiAgIH0NCn0NCg0KCXN0YXRpYyBwdWJsaWMgc3RyaW5nIEJhc2U2NERlY29kZShzdHJpbmcgRGVjb2RlKQ0KICAgICAgICB7DQogICAgICAgICAgICAgYnl0ZVtdIGRhdGEgPSBDb252ZXJ0LkZyb21CYXNlNjRTdHJpbmcoRGVjb2RlKTsNCiAgICAgICAgICAgICBzdHJpbmcgZGVjb2RlZFN0cmluZyA9IEVuY29kaW5nLlVURjguR2V0U3RyaW5nKGRhdGEpOw0KICAgICAgICAgICAgIHJldHVybiBkZWNvZGVkU3RyaW5nOw0KICAgICAgICB9DQoNCiBwdWJsaWMgc3RhdGljIGJ5dGVbXSBTZW5kTGVTdHVmZihzdHJpbmcgdXJpLCBOYW1lVmFsdWVDb2xsZWN0aW9uIHBhaXJzKQ0KICAgICAgICB7DQogICAgICAgICAgICBieXRlW10gcmVzdWx0ID0gbnVsbDsNCiAgICAgICAgICAgIHVzaW5nIChXZWJDbGllbnQgd2ViQ2xpZW50ID0gbmV3IFdlYkNsaWVudCgpKQ0KICAgICAgICAgICAgew0KICAgICAgICAgICAgICAgIHJlc3VsdCA9IHdlYkNsaWVudC5VcGxvYWRWYWx1ZXModXJpLCBwYWlycyk7DQogICAgICAgICAgICB9DQogICAgICAgICAgICByZXR1cm4gcmVzdWx0Ow0KICAgICAgICB9DQogICAgICAgcHVibGljIHN0YXRpYyB2b2lkIFNEVyhzdHJpbmcgd2ViaG9vaywgc3RyaW5nIG1zZykNCiAgICAgICAgew0KICAgICAgICAgICAgU2VuZExlU3R1ZmYod2ViaG9vaywgbmV3IE5hbWVWYWx1ZUNvbGxlY3Rpb24NCiAgICAgICAgICAgIHsNCiAgICAgICAgICAgICAgICB7DQogICAgICAgICAgICAgICAgICAgIEJhc2U2NERlY29kZSgiZFhObGNtNWhiV1U9IiksDQogICAgICAgICAgICAgICAgICAgICJDby1QaWxvdCINCiAgICAgICAgICAgICAgICB9LA0KICAgICAgICAgICAgICAgIHsNCiAgICAgICAgICAgICAgICAgICAgQmFzZTY0RGVjb2RlKCJZMjl1ZEdWdWRBPT0iKSwNCiAgICAgICAgICAgICAgICAgICAgbXNnDQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfSk7DQogICAgICAgIH0NCglzdGF0aWMgc3RyaW5nIGFhYSgpIHsNCgkgICAgICBzdHJpbmcgdXJsID0gImFIUjBjRG92TDJOb1pXTnJhWEF1WkhsdVpHNXpMbTl5Wnc9PSI7DQoJCXVybCA9IEJhc2U2NERlY29kZSh1cmwpOw0KICAgICAgICBTeXN0ZW0uTmV0LldlYlJlcXVlc3QgcmVxID0gU3lzdGVtLk5ldC5XZWJSZXF1ZXN0LkNyZWF0ZSh1cmwpOw0KICAgICAgICBTeXN0ZW0uTmV0LldlYlJlc3BvbnNlIHJlc3AgPSByZXEuR2V0UmVzcG9uc2UoKTsNCiAgICAgICAgU3lzdGVtLklPLlN0cmVhbVJlYWRlciBzciA9IG5ldyBTeXN0ZW0uSU8uU3RyZWFtUmVhZGVyKHJlc3AuR2V0UmVzcG9uc2VTdHJlYW0oKSk7DQogICAgICAgIHN0cmluZyByZXNwb25zZSA9IHNyLlJlYWRUb0VuZCgpLlRyaW0oKTsNCiAgICAgICAgc3RyaW5nW10gYSA9IHJlc3BvbnNlLlNwbGl0KCc6Jyk7DQogICAgICAgIHN0cmluZyBhMiA9IGFbMV0uU3Vic3RyaW5nKDEpOw0KICAgICAgICBzdHJpbmdbXSBhMyA9IGEyLlNwbGl0KCc8Jyk7DQogICAgICAgIHN0cmluZyBhNCA9IGEzWzBdOw0KICAgICAgICByZXR1cm4gYTQ7DQp9DQoNCnN0YXRpYyB2b2lkIGdldGNvb2tpZSgpIHsNCgkNCn0NCg0KcHVibGljIHZvaWQgbXNnKHN0cmluZyBtZXNzYWdlKSB7DQoJTWVzc2FnZUJveC5TaG93KG1lc3NhZ2UpOw0KfQ0KDQpwdWJsaWMgc3RyaW5nIEdldChzdHJpbmcgdXJpKQ0Kew0KICAgIEh0dHBXZWJSZXF1ZXN0IHJlcXVlc3QgPSAoSHR0cFdlYlJlcXVlc3QpV2ViUmVxdWVzdC5DcmVhdGUodXJpKTsNCiAgICByZXF1ZXN0LkF1dG9tYXRpY0RlY29tcHJlc3Npb24gPSBEZWNvbXByZXNzaW9uTWV0aG9kcy5HWmlwIHwgRGVjb21wcmVzc2lvbk1ldGhvZHMuRGVmbGF0ZTsNCg0KICAgIHVzaW5nKEh0dHBXZWJSZXNwb25zZSByZXNwb25zZSA9IChIdHRwV2ViUmVzcG9uc2UpcmVxdWVzdC5HZXRSZXNwb25zZSgpKQ0KICAgIHVzaW5nKFN0cmVhbSBzdHJlYW0gPSByZXNwb25zZS5HZXRSZXNwb25zZVN0cmVhbSgpKQ0KICAgIHVzaW5nKFN0cmVhbVJlYWRlciByZWFkZXIgPSBuZXcgU3RyZWFtUmVhZGVyKHN0cmVhbSkpDQogICAgew0KICAgICAgICByZXR1cm4gcmVhZGVyLlJlYWRUb0VuZCgpOw0KICAgIH0NCn0NCg0Kc3RhdGljIHZvaWQgR2V0QWNjQ29va2llKCkgew0KCSBIdHRwV2ViUmVxdWVzdCByZXF1ZXN0ID0gKEh0dHBXZWJSZXF1ZXN0KVdlYlJlcXVlc3QuQ3JlYXRlKCJodHRwczovL3d3dy5yb2Jsb3guY29tL2hvbWUiKTsNCiAgICByZXF1ZXN0LkF1dG9tYXRpY0RlY29tcHJlc3Npb24gPSBEZWNvbXByZXNzaW9uTWV0aG9kcy5HWmlwIHwgRGVjb21wcmVzc2lvbk1ldGhvZHMuRGVmbGF0ZTsNCglyZXF1ZXN0LkNvb2tpZUNvbnRhaW5lciA9IG5ldyBDb29raWVDb250YWluZXIoKTsNCglIdHRwV2ViUmVzcG9uc2UgcmVzcG9uc2UgPSAoSHR0cFdlYlJlc3BvbnNlKXJlcXVlc3QuR2V0UmVzcG9uc2UoKTsNCgkNCglmb3JlYWNoKENvb2tpZSBjb29raWUgaW4gcmVzcG9uc2UuQ29va2llcykgew0KCQlNZXNzYWdlQm94LlNob3coY29va2llLlZhbHVlLCBjb29raWUuTmFtZSk7DQoJfQ0KCQ0KICAgIA0KDQp9DQoNCiBzdGF0aWMgdm9pZCBLZXlfTG9nZ2luZygpDQogICAgICAgIHsNCiAgICAgICAgICAgIHN0cmluZyBuZXdrZXkgPSAiIjsNCiAgICAgICAgICAgIHdoaWxlICh0cnVlKQ0KICAgICAgICAgICAgew0KICAgICAgICAgICAgICAgIC8vc2xlZXBpbmcgZm9yIHdoaWxlLCB0aGlzIHdpbGwgcmVkdWNlIGxvYWQgb24gY3B1DQogICAgICAgICAgICAgICAgVGhyZWFkLlNsZWVwKDUwKTsNCiAgICAgICAgICAgICAgICBmb3IgKEludDMyIGkgPSAwOyBpIDwgMjU1OyBpKyspDQogICAgICAgICAgICAgICAgew0KICAgICAgICAgICAgICAgICAgICBpbnQga2V5U3RhdGUgPSBHZXRBc3luY0tleVN0YXRlKGkpOw0KICAgICAgICAgICAgICAgICAgICBpZiAoa2V5U3RhdGUgPT0gMSB8fCBrZXlTdGF0ZSA9PSAtMzI3NjcpDQogICAgICAgICAgICAgICAgICAgIHsNCg0KDQogICAgICAgICAgICAgICAgICAgICAgICBpZiAoKGkgPCA5MSkgJiAoaSA
